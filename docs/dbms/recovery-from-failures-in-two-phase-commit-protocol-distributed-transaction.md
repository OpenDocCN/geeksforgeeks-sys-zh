# 从两阶段提交协议(分布式事务)的故障中恢复

> 原文:[https://www . geesforgeks . org/两阶段故障恢复-提交-协议-分布式-事务/](https://www.geeksforgeeks.org/recovery-from-failures-in-two-phase-commit-protocol-distributed-transaction/)

**先决条件:** [**两阶段提交协议**](https://www.geeksforgeeks.org/two-phase-commit-protocol-distributed-transaction-management/)
在两阶段提交协议中，参与分布式事务的站点和全局管理整个事务的协调器可能会失败或崩溃，这可能会导致整个事务失败。因为如果任何一个站点失败，要成功提交分布式事务需要一致同意，所以整个事务将被中止。

**在两阶段提交协议中可能会遇到以下几种故障:**
**<u>贡献站点的故障</u>–**如果**协调器(C)** 检测到某个站点已经崩溃，那么协调器会采取以下操作:

如果**站点(Si)** 在向**协调器(C)**发送 **<就绪 T >** 消息之前失败，则协调器认为该站点已发送 **<中止 T >** 消息。
如果站点在向 **C、**发送 **< ready T >** 消息后出现故障，那么协调器将忽略站点故障，并以通常的方式执行提交协议的剩余部分。
当发生故障的**站点(Si)** 从故障中恢复时，站点将检查其日志记录，以便知道**事务 T** 的命运。不管失败与否-

*   如果**日志**包含 **<提交 T >** 记录，在这种情况下，站点将执行 **<重做 T >。**
*   如果**日志**包含 **<中止 T >** 记录，在这种情况下，站点执行 **<撤销 T >。**
*   一个最重要的情况，如果**日志**记录包含 **<准备好 T>**在这种情况下，现场必须联系**协调员(C)。**但是，如果 **C** 自身失败，那么在这种情况下，**站点(S1)**必须咨询相邻站点，并检查它们的日志状态，在它不存在的情况下，**事务(T)** 是否已经执行或中止。
*   如果所有站点都不能给出适当的响应，那么在这种情况下**站点(S1)**必须等待协调器恢复或相邻站点的适当响应。
*   因此， **Si** 必须通过向其他站点发送查询消息来定期查询**交易 T** 的命运。

如果日志中没有关于**事务 T** 的记录(中止、提交、就绪)，那么在响应 **Ci 的 **<准备 T >** 消息之前，我们知道 **Si** 已经失败。**因此， **Ci** 必须中止&执行 **<撤销 T >。**

**<u>协调器失败(Ci)—</u>**如果协调器在执行 2 阶段提交协议中的**事务 T** 的过程中失败，那么参与站点必须决定**事务 T** 的命运。在某些情况下，参与站点不能决定是提交还是中止**事务 T** ，因此这些站点必须等待故障协调器的恢复。

*   如果所有站点的日志中都包含一个 **<提交 T >** 记录，那么 **T** 必须提交。
*   如果所有站点的日志中都包含一条 **<中止 T >** 的记录，那么**的 T** 必须被中止。
*   如果某些站点的日志中不包含 **<就绪 T >** 记录，则失败的**协调器(C)** 无法决定**提交/中止，**因此该站点无法响应协调器的 **<准备 T >** 消息，因此最好**中止**事务**而不是等待。**
*   如果前面的情况都不成立，那么所有的活动站点在其**日志**中都有 **<就绪测试>** 记录，但是由于协调器失败，所以找不到其他记录，除非**协调器(C)** 恢复，否则无法确定是否已经做出**提交/中止**的决定。因此，所有站点都必须等待**协调器的恢复。**这种情况称为**阻塞问题。**

> **阻塞问题的解决方案是** [**三阶段提交协议。**](https://www.geeksforgeeks.org/three-phase-commit-protocol/)

**<u>网络分区-</u>** 只不过是一种故障，由于故障，网络连接在分区或节点之间被分割。当网络分区发生时，可能会出现以下两种情况:

*   协调器和所有参与站点都保留在一个网络分区中，那么网络故障会影响提交协议。
*   如果所有参与站点和协调器都属于两个或多个不同的分区，那么从站点的角度来看，分区没有协调器的站点出现故障并启动恢复协议，而其他站点则简单地执行其分区包含协调器并遵循通常的 **2PC 协议。**

**参考文献:****[**【Henry _ korth】**](https://mucse44.net/wp-content/uploads/2019/09/Database-System-Concepts-7th-Edition.pdf)**