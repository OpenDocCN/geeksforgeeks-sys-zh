# 操作系统中的虚拟内存

> 原文:[https://www . geesforgeks . org/虚拟内存操作系统/](https://www.geeksforgeeks.org/virtual-memory-in-operating-system/)

虚拟内存是一种存储分配方案，在这种方案中，辅助内存可以像主内存的一部分一样进行寻址。程序可以用来引用内存的地址与内存系统用来标识物理存储位置的地址是不同的，程序生成的地址被自动转换成相应的机器地址。

虚拟存储器的大小受到计算机系统的寻址方案的限制，并且可用的辅助存储器的数量不受主存储位置的实际数量的限制。

这是一种同时使用硬件和软件实现的技术。它将程序使用的内存地址(称为虚拟地址)映射到计算机内存中的物理地址。

1.  进程内的所有内存引用都是逻辑地址，在运行时动态转换为物理地址。这意味着一个进程可以在主内存中交换进出，从而在执行过程中的不同时间占据主内存中的不同位置。
2.  一个进程可以被分成多个部分，并且这些部分在执行期间不需要连续地位于主存储器中。动态运行时地址转换和使用页或段表的组合允许这样做。

如果这些特征存在，那么在执行期间，没有必要在主存储器中存在所有的页面或段。这意味着需要的页面需要随时加载到内存中。虚拟内存使用按需分页或按需分段来实现。

**按需分页:**
按需(每当发生页面故障时)将页面加载到内存中的过程称为按需分页。
流程包括以下步骤:

![virtual_mem](img/2b7c58ae6c5b153b48d54744591cb3ca.png)

1.  如果中央处理器试图引用主存储器中当前不可用的页面，它会生成一个中断，指示存储器访问故障。
2.  操作系统将中断的进程置于阻塞状态。为了继续执行，操作系统必须将所需的页面带入内存。
3.  操作系统将在逻辑地址空间中搜索所需的页面。
4.  所需页面将从逻辑地址空间带到物理地址空间。页面替换算法用于在物理地址空间中替换页面的决策。
5.  页面表将相应更新。
6.  该信号将被发送到中央处理器以继续程序执行，并且它将使进程回到就绪状态。

因此，每当发生页面错误时，操作系统都会遵循这些步骤，并将所需的页面带入内存。

**优势:**

*   更多的进程可能会保留在主内存中:因为我们将只加载任何特定进程的一些页面，所以有更多进程的空间。这导致更有效地利用处理器，因为在任何特定时间，更多进程中的至少一个更有可能处于就绪状态。
*   一个进程可能比所有的主内存都大:编程中最基本的限制之一被取消了。由于按需分页，可以执行大于主内存的进程。操作系统本身会根据需要在主内存中加载进程的页面。
*   通过为每个进程使用更少的可用(主)内存，它允许更高的多道程序级别。

**页面故障服务时间:**
服务页面故障所花费的时间称为页面故障服务时间。页面错误服务时间包括执行上述所有六个步骤所花费的时间。

```
Let Main memory access time is: m
Page fault service time is: s
Page fault rate is : p
Then, Effective memory access time = (p*s) + (1-p)*m
```

**交换:**

换出一个进程意味着从内存中移除它的所有页面，或者标记它们以便它们将被正常的页面替换进程移除。挂起一个进程可以确保它在被换出时不可运行。稍后，系统将进程从辅助存储器交换回主存储器。当一个进程忙于交换页面时，这种情况被称为“颠簸”。

![swaping](img/c05a69e04a8e8425dec38a021b6fc52a.png)

**颠簸:**

![virtual_mem_2](img/5fad2d16d8aac8df09f810db5293933a.png)

在任何给定的时间，任何进程只有几页在主内存中，因此更多的进程可以在内存中维护。此外，由于未使用的页面不会被换入和换出内存，因此节省了时间。然而，操作系统必须聪明地管理这个方案。实际上，在稳定状态下，所有的主内存都将被进程页面占据，这样处理器和操作系统就可以直接访问尽可能多的进程。因此，当操作系统引入一个页面时，它必须抛出另一个页面。如果它在使用之前抛出了一个页面，那么它将不得不立即再次得到那个页面。过多的这种情况会导致一种叫做“颠簸”的情况。系统花费大部分时间交换页面，而不是执行指令。所以需要一个好的页面替换算法。

在给定的图表中，多道程序的初始程度达到某个程度点(λ)，CPU 利用率非常高，系统资源得到 100%的利用。但是，如果我们进一步提高多道程序设计的程度，CPU 利用率将大幅下降，系统将花费更多的时间仅在页面替换上，完成进程执行所需的时间将会增加。系统中的这种情况称为抖动。

**颠簸原因:**

1.  **High degree of multiprogramming** : If the number of processes keeps on increasing in the memory then the number of frames allocated to each process will be decreased. So, fewer frames will be available for each process. Due to this, a page fault will occur more frequently and more CPU time will be wasted in just swapping in and out of pages and the utilization will keep on decreasing. 

    例如:
    让自由帧数= 400
    **情况 1** :进程数= 100
    那么，每个进程将得到 4 帧。

    **情况 2** :进程数= 400
    每个进程得到 1 帧。
    情况 2 是抖动的情况，随着进程数量的增加，每个进程的帧数减少。因此，交换页面会消耗 CPU 时间。

2.  **缺少帧**:如果一个进程有更少的帧，那么该进程能够驻留在内存中的页面就会更少，因此需要更频繁的交换。这可能会导致颠簸。因此，必须为每个进程分配足够数量的帧，以防止抖动。

**颠簸恢复:**

*   不要通过指示长期调度程序不要在阈值后将进程带入内存来让系统进入颠簸状态。
*   如果系统已经在颠簸，那么指示中期调度器暂停一些进程，以便我们可以从颠簸中恢复系统。